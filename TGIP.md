# 地形生成アルゴリズム実装計画 (Terrain Generation Implementation Plan)

## 1. コンセプト
単なるノイズの重ね合わせではなく、プレートの動きや気候モデルなどの「物理的プロセス」をシミュレートすることで、2Dでありながら地球に近い、説得力のある地形を生成する。

## 2. システム基盤
- **シード値管理**: 全ての乱数生成はシード値に依存する擬似乱数ジェネレータ（PRNG）を介して行い、再現性を100%確保する。
- **データ構造**:
    - **マクログリッド**: 世界を広域（例：16x16チャンク単位）で管理する低解像度データレイヤー。
    - **チャンク**: プレイヤーが実際に活動する高解像度データ。マクログリッドの値を補完して使用する。
    - 各セルは「標高」「温度」「湿度」「プレートID」「地質的ストレス」などのプロパティを持つ。

## 3. 生成フェーズ

### フェーズ1：巨地形 (Macro Terrain) - プレートシミュレーション
1.  **プレート分割**: 
    - Voronoi図を用いて領域を分割し、各領域を「プレート」として定義する。
2.  **プレート特性の割当**:
    - 各プレートに「移動ベクトル（方向と速さ）」と「種類（海洋プレート/大陸プレート）」を割り当てる。
3.  **境界相互作用の計算**:
    - プレートの境界において以下の関係を算出する：
        - **収束型 (Convergent)**: プレート同士が衝突。大陸間なら山脈、海洋・大陸間なら海溝や火山帯を生成。
        - **発散型 (Divergent)**: プレートが離れる。海嶺や裂谷を生成。
        - **変換断層 (Transform)**: プレートがすれ違う。複雑な断層地形を生成。

### フェーズ2：大地形 (Meso Terrain) - ノイズ合成
1.  **ベース標高の生成**:
    - フェーズ1の衝突ストレスを基底とし、そこに複数の周波数のノイズ（PerlinやSimplex）を重ね合わせる（Fractal Brownian Motion）。
2.  **マスク処理**:
    - プレート境界に近いほど標高の変化を激しくし、プレート中央部は比較的平坦になるようノイズ強度を制御する。

### フェーズ3：バイオームと気候 (Biomes & Climate)
1.  **基本パラメータの算出**:
    - **温度**: 緯度（X座標？）と標高に基づく減衰モデル。
    - **湿度**: 海からの距離、および山脈による雨陰効果（Orographic effect）を近似的に計算。
2.  **バイオーム決定**:
    - 「標高・温度・湿度」の3軸モデル（Whittakerのバイオーム分類を拡張）を用いて、各セルのバイオームを決定。
    - 例：高地＋低温＝高山、低地＋高温＋高湿度＝熱帯雨林、境界部＋高ストレス＝火山。

### フェーズ4：微地形と仕上げ (Micro Terrain & Erosion)
1.  **侵食シミュレーションと露頭 (Erosion & Outcrop)**:
    - 水力侵食（Hydraulic Erosion）を計算し、高標高地の土壌層を削り取る。
    - **露頭の生成**: 侵食が激しい地点では、深部の岩盤や鉱脈を地表に露出（Outcrop）させ、プレイヤーが地表探索のみで資源を発見できるようにする。
2.  **地物配置**:
    - バイオームに応じた植生、河川の起点、堆積物の配置。

### フェーズ5：垂直構造と深部地質 (Vertical Strata & Deep Geology)
1.  **プレート厚の設定**:
    - **海洋プレート**: 地殻が薄く、比較的浅い位置で高硬度な岩盤や熱源（マグマ）に到達する。
    - **大陸プレート**: 地殻が厚く、深部まで掘り進められるが、古く硬い「盾状地」岩盤が存在する。
2.  **深度による環境変化**:
    - 標高とプレート特性に基づき、深度ごとの温度上昇率（地温勾配）を設定。

### フェーズ7：地層システムと構造地質 (Stratigraphy & Structure)
1.  **三層モデルの導入**:
    - **堆積岩層**: 柔らかく、石炭や化石などの有機資源を含む。
    - **変成岩層**: プレートの圧力による硬化層。宝石類を含む。
    - **火成岩層**: 非常に硬い基盤。深部金属資源を含む。
2.  **地層の変形 (Deformation)**:
    - **褶曲 (Folding)**: 低周波ノイズを用いて地層境界を波打たせ、視覚的な変化を与える。
    - **断層 (Faulting)**: プレート境界付近で垂直・斜め方向の不連続面を生成。資源分布の急激な変化点とする。

### フェーズ8：鉱床生成プロセス (Mineralization)
1.  **熱水鉱脈型 (Hydrothermal)**:
    - 断層や岩石の割れ目に沿って生成。金・銀・水晶など、線状・脈状の分布。
2.  **正マグマ型 (Magmatic)**:
    - マグマ溜まり周辺や火成岩層の底部に生成。鉄・ニッケルなど、塊状の分布。
3.  **堆積・漂砂鉱床型 (Sedimentary/Placer)**:
    - 地表の凹地や旧河川敷に生成。砂金・砂鉄・石炭など、水平・レンズ状の分布。

## 4. 発展的要素 (Advanced Features)

### フェーズ9：中・小地形のダイナミクス (Geomorphology)
1.  **盆地 (Basin) と平地**: 
    - 低地に厚い堆積層を生成。石炭や石油、地下水が豊富で掘りやすいが、崩落に注意が必要。
2.  **台地 (Plateau) と山岳**: 
    - 隆起した平坦地。側面が崖（露頭）になりやすく、水平方向に掘ることで深部の地層にアクセスできる。
3.  **河川システム (Fluviology)**:
    - 標高モデルに基づいた流体経路決定。
    - 湿潤バイオームでは大きな川、乾燥地では枯れ川（ワジ）となり、周囲に砂利や砂金を含む堆積層を作る。

### フェーズ10：詳細気候バイオーム (Detailed Biomes)
1.  **温度・湿度の三次元的決定**:
    - **緯度**: 南北（Y軸）による基本温度勾配。
    - **雨陰効果 (Rain Shadow)**: 山脈の風上は多湿（熱帯雨林・温帯林）、風下は乾燥（草原・砂漠）となるプロセス。
2.  **バイオーム特性**:
    - **熱帯雨林**: 深い土壌層と化学的風化による特殊鉱物。
    - **乾燥砂漠**: 砂（重力崩落）と、蒸発岩（岩塩等）の層。
    - **極地・高山**: **永久凍土 (Permafrost)** 層。非常に硬く、解かすための装備や熱源が必要。

### フェーズ11：地質学的ギミック (Geological Gimmicks)
1.  **自然洞窟と空洞**:
    - 石灰岩地帯の鍾乳洞、火山地帯の溶岩チューブ。
2.  **古生物と考古学**:
    - 特定層に含まれる化石、古代の遺物。探索のボーナス要素。
3.  **地下水と帯水層 (Aquifers)**:
    - 掘り当てると浸水が発生する層。ポンプによる排水管理の必要性。

## 5. マクログリッド・システム (Macro Grid System)
1.  **解像度定義**:
    - 1セル = 8x8チャンク（128x128ブロック相当）として定義。
2.  **保持データ**:
    - `plate_id`: プレート所属。境界判定に使用。
    - `geological_stress`: プレート境界からの距離に基づく圧力値。山脈の高さや鉱脈の密度に直結。
    - `temperature_base`: 緯度（X軸）と高度（Y軸）に基づく基本温度。
    - `humidity_base`: 海（または水域）からの距離に基づく基本湿度。
    - `sediment_depth`: 堆積層の厚さ。盆地では厚く、山岳では薄い。
3.  **生成と補間**:
    - 世界生成時にまずマクログリッドを決定。
    - チャンク生成時、チャンクの中心座標に対応するマクログリッドの周囲4セルから**双線形補完 (Bilinear Interpolation)** を行い、そのチャンク固有の環境パラメータを算出する。

## 6. 実装のステップ
1.  **Step 1**: シード値に基づくVoronoi分割とマクログリッド構造の構築。
2.  **Step 2**: マクログリッド情報の補間アルゴリズムの実装（チャンク生成への統合）。
3.  **Step 3**: 地層のベースライン（褶曲・断層含む）と標高マップの生成。
4.  **Step 4**: 侵食計算による地表の整形と「露頭」の判定。
5.  **Step 5**: 温度・湿度・地質に基づくバイオームと鉱床（熱水・マグマ等）の配置。
6.  **Step 6**: ハザード系（崩落・流体）の実装と統合。
7.  **Step 7**: (発展) 中・小地形（川・盆地）と詳細バイオームの適用。

## 7. 実装上の工夫 (Technical Strategy)
- **キャッシュ戦略**:
    - 生成済みのマクログリッドはセーブデータに保持、またはシード値からオンデマンドで再生成可能にする。
- **スケーラビリティ**:
    - サイドビューの特性上、X軸方向の変化（バイオーム）とY軸方向の変化（地質）を独立した重み付けで合成し、探索の多様性を確保する。
- **マクロマップ補間**:
    - 全体のプレート情報は低解像度の「グローバル・グリッド」として保持。
    - 各チャンク生成時に周囲のグリッドからパラメータ（ストレス、温度、湿度）を線形補間（Bilinear Interpolation）することで、境界の滑らかさと計算負荷の軽減を両立する。

## 8. 拡張性
- 将来的には、シミュレーション時間を「地質学的時間軸」として進め、地形が動的に変化する機能への拡張を考慮する。
- プレイヤーによる大規模な採掘が地域の「地質的安定度」に影響を与えるシステムへの発展。
