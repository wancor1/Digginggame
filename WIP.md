# 水（液体）システム実装計画 (Water Implementation Plan)

このドキュメントは、掘削ゲームにおける動的な流体システムの導入計画をまとめたものです。

## 1. データ構造の拡張

### Block 構造体 (`src/components.rs`)
- `liquid_level: u8` フィールドを追加。
  - `0`: 水なし
  - `1〜8`: 水位（8が満水）
- `Block::new` 時に初期水位を 0 または設定可能にする。

### BlockType (`src/managers/block.rs`)
- `is_liquid(&self) -> bool` メソッドを実装。
- `data/blocks/liquid.json` のカテゴリ判定を利用。

## 2. 流体シミュレーション (セル・オートマトン方式)

### WorldManager の拡張
- `active_liquids: HashSet<(i32, i32)>` を追加。
- 毎フレーム、全てのブロックをスキャンするのではなく、動きがある液体の座標のみを追跡。

### 更新ロジック (`update_liquids`)
1. **更新範囲の制限**: パフォーマンス維持と未ロード領域での不具合防止のため、カメラに映る範囲＋周囲数チャンク（アクティブ範囲）内のみでシミュレーションを実行。
2. **下方移動**: 下のブロックが `Air` または水位の低い液体の場合、水量を下に移動。
3. **水平拡散**: 下が固体または満水の場合、左右の隣接ブロックへ水量を平均化するように広げる。
4. **状態伝播**: 水が移動した際、周囲のブロックを次フレームの `active_liquids` に登録。
5. **最小値処理**: 水位が 1 未満になった場合は `Air` に戻し、シミュレーションを停止。

## 3. レンダリングの対応 (`src/render/world_renderer.rs`)

- 液体ブロック描画時に `liquid_level` を参照。
- `height = (level / 8.0) * BLOCK_SIZE` で描画高さを動的に変更。
- アルファチャンネルを適用し、背景が見えるように透過レンダリングを行う。

## 4. プレイヤー・物理挙動への影響

- **水中判定**: プレイヤー座標の `liquid_level > 4` 程度で水中状態とする。
- **浮力**: 水中では `vy` に対して上方向の加速度を適用。
- **抵抗**: 水中での `vx`, `vy` の減衰率を増加させ、動きを重くする。

## 5. インタラクションとアイテム

- **バケツ/ポンプ**: 水を収集・再配置するツールの追加。
- **ワールド生成**: `generation.rs` で洞窟や特定の深度に水溜まりを生成。

## 6. 将来的な拡張

- **水圧システム**: 現在の単純な拡散に加え、上方の水重による下方・水平への押し出しや、密閉空間での水位上昇（水圧によるせり上がり）の導入を検討。

---

## 実装ステップ

1. **Phase 1**: `Block` へのフィールド追加と水位に応じた描画ロジック。
2. **Phase 2**: 垂直移動（自由落下）シミュレーション。
3. **Phase 3**: 水平拡散と `active_liquids` による最適化。
4. **Phase 4**: プレイヤーの物理挙動調整（浮力・抵抗）。
5. **Phase 5**: 水圧システムの実装（検討後）。
